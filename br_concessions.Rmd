---
title: "Sustainability of Brazilian forest concessions"
author:
  - Plinio Sist:
      email: plinio.sist@cirad.fr
      institute: [fs,co]
      correspondence: true
  - Camille Piponiot:
      institute: [fs,co] 
  - Milton Kanashiro:
      institute: [embrapa] 
  - Lucas Mazzei:
      institute: [embrapa] 
  - Marielos Pena-Claros:
      institute: [wagen] 
  - Francis E Putz:
      institute: [flo] 
  - Ademir R Ruschel:
      institute: [embrapa]  
  - Mark Schulze:
      institute: [ore] 
  - Alberto Verissimo:
      institute: [imazon]
  - Edson Vidal:
      institute: [usp] 

institute:
  - fs: UR Forests and Societies, Cirad, Université de Montpellier, Montpellier, France
  - embrapa: Embrapa Amazônia Oriental, Belém, Brazil
  - wagen: Forest Ecologyand Forest Management Group, Wageningen University, Wageningen, The Netherlands
  - flo: Department of Biology, University of Florida, Gainesville, United States of America
  - ore: Oregon State University, Blue River, United States of America
  - imazon: Institute for People and the Environment of Amazonia, IMAZON, Belém, Brazil
  - usp: Department of Forest Sciences, "Luiz de Queiroz” College of Agriculture, University of São Paulo, Piracicaba, Brazil
  - co: Contributed equally to this work

journal: "Forest Ecology and Management"
output: 
  bookdown::word_document2:
    pandoc_args:
      - '--lua-filter=common/scholarly-metadata.lua'
      - '--lua-filter=common/author-info-blocks.lua'
    reference_docx: word-styles-ref-01.docx
    number_sections: true
  fig_caption: yes
bibliography: myBiblio.bib
csl: forest-ecology-and-management.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, results='hide', 
                      root.dir = rprojroot::find_rstudio_root_file())
# load libraries
packages_needed <- c("knitr", "data.table", "ggplot2", "parallel", "sp", 
                     "truncnorm", "tmap", "latex2exp", "flextable")
packages_to_install <- packages_needed[!( packages_needed %in% rownames(installed.packages()))]
if (length(packages_to_install) > 0)
  install.packages(packages_to_install)
lapply(packages_needed, require, character.only = TRUE)

## source all functions
file.sources = list.files(path = "R/", pattern="*.R", full.names = TRUE)
sapply(file.sources, source, .GlobalEnv)

if (!dir.exists("cache"))
  dir.create("cache")
```

---

# Abstract {-}

Insert abstract here

---

# Introduction

Legal logging in the tropics is typically governed by simple rules that set a minimum cutting diameter and a minimum cutting cycle of 25-35 years [@Putz2008]. Timber harvests in diverse forests are selective because few species are marketable and few trees meet the size and bole quality requirements. In the Amazon, selective logging regulations typically set a rotation cycle of 20 to 35 years with a logging intensity varying from 15 to 30 m$^3$ of harvested timber per ha. Such rules, promulgated by governments since the middle of last century, are generally based on an assumed post-logging rate of commercial timber volume increments of about 1 m$^3$.ha$^{-1}$.year$^{-1}$ (0.86 m$^3$.ha$^{-1}$.year$^{-1}$ in Brazilian Amazon). These rules are set to accommodate processing technologies and market demands, rather than the biology and conservation of the harvested species [@Sist2007]. Unfortunately for the goal of sustainability, research reports over the past decades demonstrated that volume recovery rates fall short of this expectation by 50% [reviewed by @Putz2012]. A recent simulation of post-logging timber volume recovery rates in the Amazon Basin showed that even with cutting cycles of 65 years and logging intensities of only 20 m$^3$.ha$^{-1}$, logged forests recover only 70% of their pre-logging timber stocks [@Piponiot2019]. Other researchers showed that current harvest regimes can only be sustained over multiple cycles if high-value slow-growing hardwoods are replaced by fast-growing species with low density wood of little market value [@Alder2000;@Keller2004;@Phillips2004;@VanGardingen2006;@Sist2007;@Schulze2008]. Here we use a timber recovery model [@Piponiot2019] to estimate the timber volumes that could be produced by all the logging concessions in the Brazilian Amazon with different cutting cycle lengths, logging intensities, and lengths of the list of commercial species. 

Despite low rates of post-harvest timber stock recovery, selective logging is still widespread and economically important land use in the tropics in general and Amazon Basin in particular. In that region, forest degradation due to illegal logging is widespread [@Brancalion2018;@Finer2014;@Potapov2017] and, in the Brazilian Amazon, affects now bigger areas than deforestation [@Matricardi2020]. This makes difficult to assess the region's current potential for timber production. What is clear, in contrast, is that without control of illegal logging and improved practices where logging is legal, timber yields from logged forests will decline dramatically [@Putz2012;@Piponiot2019], decreasing the likelihood of their meeting the demand for timber.

In 2006, the Brazilian Forest Service (SFB) was created to establish a very ambitious system of long-term logging concessions [@Brazil2006]. The goals are to provide a legal framework for sustainable timber production in Amazonian forests while reducing illegal logging. Forest concessions in the Brazilian Amazon currently cover only 1.6 million ha [@SFB2019], but the maximum potential area is estimated up to 60 million ha [@Bomfim2016]. The current timber production rate from established forest concessions is 221,000 m$^3$ per year, which is only 2% of the timber extracted from the region [@SFB2019]. Given that these concessions are to be managed with a 50 cm minimum cutting diameter (with the exception of *Swientenia macrophylla*: 60 cm) and a 25-35 year cutting cycle coupled with rising demand for wood products, the assessment of the expected timber production from these forests over the long term is warranted. 

In this paper we assess the timber yield sustainability of different logging intensities and harvest cycle durations from forest concessions in the Brazilian Amazon. We assess whether the potential annual timber production is adequate to meet the estimated present timber demand of 11 Mm$^3$.yr$^{-1}$ [@Vidal2020;@SFB2019].

# Methods

## Study areas - Brazilian concessions

```{r get-prop-concess}
if (!file.exists("data/pconcessions.Rdata")) {
  ## current concessions ####
  concessions <- rgdal::readOGR(dsn = "data_sfb/final", layer = "BRconc")
  # define new raster with resolution = 1 degree
  ext2 <- floor(raster::extent(concessions)) + c(0, 1, 0, 1)
  rst <- raster::raster(resolution = 0.01, ext = ext2)
  ## transform shapefile into raster with 1 degree resolution
  raster_concessions <- raster::rasterize(concessions, rst)
  raster_concessions2 <- !is.na(raster_concessions)
  pconcessions <- raster::aggregate(raster_concessions2, fact = 100)
  pconcessions <- raster::as.data.frame(pconcessions, xy = TRUE)
  colnames(pconcessions) <- c("long", "lat", "pConcess")
  
  ## all potential concessions ####
  flonas <- rgdal::readOGR(dsn = "data_sfb/final", layer = "BRflopub")
  # define new raster with resolution = 1 degree
  ext2 <- floor(raster::extent(flonas)) + c(0, 1, 0, 1)
  rst <- raster::raster(resolution = 0.01, ext = ext2)
  raster_flonas <- raster::rasterize(flonas, rst)
  raster_flonas2 <- !is.na(raster_flonas)
  pflonas <- raster::aggregate(raster_flonas2, fact = 100)
  pflonas <- raster::as.data.frame(pflonas, xy = TRUE)
  colnames(pflonas) <- c("long", "lat", "pFlona")
  
  pconcessions <- merge(pconcessions, pflonas, by = c("long", "lat"), all = TRUE)
  pconcessions[is.na(pconcessions$pConcess), "pConcess"] <- 0
  pconcessions <- subset(pconcessions, pConcess > 0 | pFlona > 0)
  save(pconcessions, file = "data/pconcessions.Rdata")
} else load("data/pconcessions.Rdata")
```

Our study focuses on forest concessions in the Brazilian Amazon (Figure\@ref(fig:map-brazil-concess)). These concessions are located in public forests and currently cover 1.6 Mha, of which 1.05 Mha are managed by the SFB, and 0.6 Mha are managed by state-level agencies [@SFB2019]. We defined the area of all potential concessions as the area of all public forests that (i) are in the Brazilian Amazon biome, (ii) are designated for sustainable use, and (iii) are not community forests - although community forest management is legal and currently cover around 260.000 ha [REF: Miranda 2020], indigenous territories or military areas (as defined in @SFB2019, p. 112; Figure\@ref(fig:map-brazil-concess)]. Based on this definition, the potential concession area in the Brazilian Amazon cover an estimated of 35 Mha. This area is lower than the 60 Mha estimated by @Bomfim2016; **explanation?**. 

```{r map-brazil-concess, fig.height = 5, fig.width = 8, fig.cap = "Forest concessions in the Brazilian Amazon. Current federal concessions are in red; potential concessions (public forests designated for sustainable use) are in blue [retrieved from Brazilian Forest Service and IDEFLOR websites [@SFB2020;@SFB2019a;@IDEFLOR2020]]."}
concessions <- rgdal::readOGR(dsn = "data_sfb/final", layer = "BRconc")
concessions$ppf <- "current"
flopub <- rgdal::readOGR(dsn = "data_sfb/final", layer = "BRflopub")
flopub <- rbind(flopub, concessions)
map.samerica <- rgdal::readOGR("D:/Mes Donnees/maps/borders/South_America", "South_America")
map.samerica <- raster::crop(map.samerica, raster::extent(-85,-33,-56,13))
nb_region = sf::st_as_sfc(sf::st_bbox(c(xmin = -74, xmax = -44, ymin = -11, ymax = 5),
                                      crs = sf::st_crs(map.samerica)))
conc_map = tm_shape(map.samerica, bbox = nb_region) +  ## maybe just subset world map
  tm_polygons(alpha = 0) +
  tm_shape(flopub) +
  tm_fill(col = "ppf", 
          title = "Concession area", 
          palette = c("firebrick3", "dodgerblue2")) + 
  tm_compass(type = "8star", position = c("right", "bottom")) +
  tm_scale_bar(breaks = c(0, 100, 200), text.size = 1)
sam_map = tm_shape(map.samerica) + tm_polygons() + 
  tm_shape(nb_region) + tm_borders(lwd = 3) 

conc_map
print(sam_map, vp = grid::viewport(0.1, 0.7, width = 0.2, height = 0.4))
``` 


```{r get-area-pixels}
raster_conc <- expand.grid(long = seq(min(pconcessions$long), max(pconcessions$long)), 
                           lat = seq(min(pconcessions$lat), max(pconcessions$lat)))
coordinates(raster_conc) <- ~long + lat
proj4string(raster_conc) <- CRS("+proj=longlat +datum=WGS84")
gridded(raster_conc) <- TRUE
areatot <- raster::area(raster::raster(raster_conc)) ## pixel area, in km2
raster_conc$area <- raster::extract(areatot, raster_conc)*100 ## km -> ha

pconcessions <- merge(pconcessions, 
                      as.data.frame(raster_conc), 
                      by = c("long", "lat"))

## all pixels with flonas (potential concessions): will be used in simulations
locations <- subset(pconcessions, pFlona > 0 | pConcess > 0)
locations$site <- 1:nrow(locations)
## multiply by factor pi = 8.2/(8.2+5.9)
## TODO add this to iterations as pi = rbeta(100, 8.2, 5.9)
pi = 8.2/(8.2+5.9)
locations$pConcess <- locations$pConcess*pi
locations$pFlona <- locations$pFlona*pi
```


## The VDDE model 

In this study we used the volume dynamics with differential equations model (VDDE) [@Piponiot2018]. The VDDE model calculates the volume of all live trees $\geq$ 50 cm diameter at breast height (DBH), the standard minimum cutting size in the Brazilian Amazon. The portion of this volume composed of commercial species is referred to as the commercial volume.

The input variables set for each simulation are logging intensity, logging cycle length, and the initial proportion of the volume that is commercial ($\omega_0$). Low values of $\omega_0$ represent highly selective logging where only the most valuable species are harvested whereas high values mean that most species are logged. Other parameters of the VDDE model are spatially defined at a 1$^\circ$ resolution. The model was calibrated for the Amazon Basin with a Bayesian framework with data from 3500 ha of forest plots, among which 845 ha are from 15 sites monitored for as long as 30 years after selective logging [@Sist2015;@Piponiot2019]. Predictions of commercial volume recovery rates thereby vary with location.

Each logging cycle includes the harvest itself as a function of logging intensity and forest characteristics and the post-logging volume recovery phase, which varies with logging cycle length and forest characteristics. Logging lowers both the total volume and the proportion of commercial volume, but both then increase during the recovery phase, although the proportion of commercial volume takes longer to recover because it relies solely on the recruitment of trees < 50 cm DBH [@Piponiot2019]. These two steps are sequentially repeated to simulate 1000 years of logging.

The results are then multiplied by the area of current or potential concessions in each 1$^\circ$ pixel, and by a factor $\pi \sim \mathcal{Beta}(8.2, 5.9)$ between 0 and 1, with a mean value of 58%. This factor $\pi$, which was calibrated with data from logging concessions in French Guiana, reflects the ratio between logged areas and the initially allocated areas, mostly because of slope restrictions and riparian reserves, but also heavy forest degradation because of illegal logging and other disturbances [@Verissimo2006;@Piponiot2019]. 

Uncertainties are propagated throughout the model by drawing all parameter values from their calibrated distribution [from @Piponiot2019], and simulating logging cycles with these parameter values. This process is repeated 100 times and summary statistics (medians and 95% credibility intervals) are calculated at each time step.

## Testing scenarios

We tested 27 different scenarios by using combinations of the following inputs: (i) initial proportion of commercial volume: 20% (highly selective), 50% (intermediate) or 90% (non-selective); (ii) logging intensity: 10 m3.ha-1 (low), 20 m$^3$.ha$^{-1}$ (intermediate) or 30 m$^3$.ha$^{-1}$ (high); (iii) cutting cycle length: 20 years (short), 35 years (intermediate) or 60 years (long). These scenarios are then applied to the current area of concessions and to the area of all potential concessions (see “Study areas”).

For each scenario we simulated 1000 years of logging cycles, and determined the duration of maintained timber production, i.e. the time before timber stocks become insufficient to maintain a constant timber production as illustrated in Figure\@ref(fig:illust-sust-log). This maintained production is different from sustained timber production which theoretically shows a constant timber yield and stock over time (Figure\@ref(fig:illust-sust-log)).

```{r illust-sust-log, fig.height = 4, fig.width = 8, fig.cap = "Illustration of the duration of maintained and sustained timber production. The x-axis represents years after the first selective harvest, and the y-axis represents commercial volumes as simulated by the model with a logging intensity of 10 m$^3$.ha$^{-1}$ and a logging cycle of 60 years. At each harvest, commercial volumes decrease (blue segments). If logging cycles are not long enough to allow recovery, the commercial volume decreases until it is not sufficient to maintain a constant production (10, 20 or 30 m$^3$.ha$^{-1}$, red segments). The time taken to reach this limit is the duration of the maintained production. In the sustained timber production, both timber yield and stocks remain constant."}
logCyc = 60
logInt = 10

dfsimu = simulateLogging(
  timeLength = 1000,
  logIntensity = logInt,
  logCycle = logCyc,
  omega0 = 0.5,
  uncertainties = FALSE,
  longitude = -60,
  latitude = 0
)
dfvol = dcast(subset(dfsimu, variable!="vextReal"), ncycle + trec ~ variable)
dfvol$vcom = dfvol$volume*dfvol$omega
dfcycle = dcast(dfvol, ncycle ~ trec, value.var = "vcom")
colnames(dfcycle) <- c("ncycle", "pl", "pr")
dfcycle[, pl := c(pl[-1], NA)]
dfvext = subset(dfsimu, variable=="vextReal")
tsust = max(dfvext[value==logInt, "ncycle"])*logCyc

## 'sustainable logging'
slope = (dfvol[ncycle==2&trec==60]$vcom-dfvol[ncycle==2&trec==1]$vcom)/59
interc = dfvol[ncycle==2&trec==1]$vcom - 61*slope
lsust = (dfvol[ncycle==1&trec==60]$vcom-interc)/slope - 61

dfsust = data.frame(x = lsust*c(0, rep(1:5, each = 2)) + 61 + rep(1:5,each = 2)[1:11], 
                    y = rep(c(dfvol[ncycle==2&trec==1]$vcom, 
                              dfvol[ncycle==1&trec==60]$vcom), 8)[1:11])

ggplot() +
  geom_line(data = dfsust, aes(x=x, y=y)) +
  geom_vline(xintercept = tsust, lty = 2) + 
  geom_line(data = dfvol, aes(x = trec+logCyc*(ncycle-1), y = vcom)) + 
  geom_segment(data = dfcycle, 
               aes(x = logCyc*ncycle, xend = logCyc*ncycle+1, 
                   yend = pl, y = pr), col = 4, lwd = 1) + 
  geom_segment(data = subset(dfcycle, ncycle >= max(dfvext[value==logInt, "ncycle"])), 
               aes(x = logCyc*ncycle, xend = logCyc*ncycle+1, 
                   yend = pl, y = pr), col = 2, lwd = 1) + 
  annotate(geom = "segment", x = 0, xend = tsust, y = 57, yend = 57,
           arrow = arrow(length = unit(0.2, "cm"), ends = "both")) +
  annotate(geom = "text", x = c(500, 820, 820, 350), y = c(25, 10, 45, 59), 
           col = c(4,2, 1, 1),
           label = c("Maintained\nproduction", "Timber depletion", 
                     "Sustained timber\nproduction",
                     "Duration of maintained production (tsust)")) +
  labs(x = "Time after first logging event (yr)", y = "Commercial volume") + 
  theme_classic() + 
  scale_x_continuous(expand = c(0, 0)) + 
  scale_y_continuous(expand = c(0, 0)) +
  expand_limits(y = c(0,60))
``` 

```{r define-simulations}
timeLength <- 200
omega0 <- c(0.2, 0.5, 0.9)
logIntensity <- (1:3)*10
logCycle <- c(20, 35, 60)
simulations <- expand.grid(omega0 = omega0, 
                           logIntensity = logIntensity, 
                           logCycle = logCycle)
simulations$simid <- 1:nrow(simulations)
```

```{r run-simulations}
if (!dir.exists("cache/simulations_concessionsBR/"))
  dir.create("cache/simulations_concessionsBR/")

all_i = 1:nrow(simulations)
del_i = as.numeric(gsub("recov|\\.Rdata", "", list.files("cache/simulations_concessionsBR/")))
missing_simus <- all_i[!all_i%in%del_i]

if (length(missing_simus) > 0) {
  source("R/simulateLogging.R")
  
  # Calculate the number of cores
  no_cores <- detectCores() - 2
  # Initiate cluster
  cl <- makeCluster(no_cores)
  clusterEvalQ(cl, library(data.table))
  clusterExport(cl, varlist = c("simulateLogging", "simulations", "timeLength", "locations", "rtruncnorm"))
  
  recovCycles <- parLapply(cl, missing_simus, function(j) {
    recov <- simulateLogging(
      timeLength = 1000,
      logIntensity = simulations$logIntensity[j],
      logCycle = simulations$logCycle[j],
      omega0 = simulations$omega0[j],
      longitude = locations$long,
      latitude = locations$lat,
      uncertainties = TRUE, keepAll = FALSE
    )
    save(recov, file = paste0("cache/simulations_concessionsBR/recov", j, ".Rdata"))
    return(recov)
  })
  
  stopCluster(cl)
}
```

```{r prepare-results}
outputs <- lapply(list.files("cache/simulations_concessionsBR/", full.name = TRUE), function(fnm){
  load(fnm)
  get("recov")
})
names(outputs) <- gsub("recov|\\.Rdata", "", list.files("cache/simulations_concessionsBR/"))

results <- rbindlist(outputs, idcol = "simid")
results$simid <- as.numeric(results$simid)

## multiply by total area ####
results <- merge(results, locations, by = "site")
results <- melt(results, measure.vars = c("pConcess", "pFlona"), 
                variable.name = "ppf", value.name = "pArea", value.factor = TRUE)
levels(results$ppf) <- c("current", "potential")
results <- subset(results, pArea > 0)
```

```{r get-timber-production}
dfvext <- subset(results, variable == "vextReal")
## multiply by area and sum (or mean for omega0)
dfvext <- dfvext[, .(lwr = sum(lwr*pArea*area),
                     med = sum(med*pArea*area), 
                     upr = sum(upr*pArea*area)), 
                 .(simid, ncycle, trec, ppf)]
# add simulation info
dfvext <- merge(dfvext, simulations, by = "simid")
```

```{r get-timber-stocks}
dfvolume <- subset(results, variable != "vextReal")
dfvolume <-
  dcast(dfvolume, value.var = c("lwr", "med", "upr"),
        ncycle + trec + simid + ppf + area + pArea + site ~ variable
  )
dfvolume$lwr <- dfvolume$lwr_omega*dfvolume$lwr_volume
dfvolume$med <- dfvolume$med_omega*dfvolume$med_volume
dfvolume$upr <- dfvolume$upr_omega*dfvolume$upr_volume
dfvolume <- dfvolume[, .(lwr = sum(lwr*pArea*area),
                         med = sum(med*pArea*area), 
                         upr = sum(upr*pArea*area)), 
                     .(simid, ncycle, trec, ppf)]
dfvolume <- dfvolume[, c("ncycle", "trec", "simid", "ppf", "lwr", "med", "upr")]
```

```{r add-volume0}
## add volume0
## initial maturity and volume
load("data/paramStan.Rdata")
dfPred <- spatialPars(locations[, c("long", "lat")], uncert = TRUE)
dfPred$dti <- sample(pars_dti, nrow(dfPred), replace = TRUE)

dfPred[, matInit := stem_mort ^ (-lambda_ti) * (1 - dti)]
dfPred[, vol0 := volume(matInit, aG_FORMIND, aM, bP, bM, theta)]

dfvol0 <- dfPred[, .(variable = "volume", 
                     lwr = quantile(vol0, 0.025), 
                     med = quantile(vol0, 0.5), 
                     upr = quantile(vol0, 0.975)), 
                 .(long, lat)]
dfvol0 <- merge(dfvol0, locations, by = c("long", "lat"))
dfvol0 <- melt(dfvol0, measure.vars = c("pConcess", "pFlona"), 
               variable.name = "ppf", value.name = "pArea", value.factor = TRUE)
levels(dfvol0$ppf) <- c("current", "potential")
dfvol0 <- subset(dfvol0, pArea > 0)
dfvol0 <- dfvol0[, .(lwr = sum(lwr*pArea*area), 
                     med = sum(med*pArea*area),
                     upr = sum(upr*pArea*area),
                     trec = 0, ncycle = 1), .(ppf)]

dfres <- expand.grid(ppf = c("current", "potential"), simid = simulations$simid)
dfres <- merge(dfres, simulations[, c("simid", "omega0")])
dfres <- merge(dfvol0, dfres, by = "ppf")
dfres[, `:=`(lwr = omega0*lwr, med = omega0*med, upr = omega0*upr)]
dfvolume <- rbind(dfvolume, dfres[, colnames(dfvolume), with = FALSE])
```

```{r annualize-volume}
dfvolume <- subset(dfvolume, trec != 1)
dfvolume <- merge(dfvolume, simulations, by = "simid")
dfvolume[, t := (ncycle-1)*logCycle + trec]
```



# Results

```{r calc-tsust}
dftsust <- lapply(outputs, function(df) { 
  df <- subset(df, variable == "vextReal")
  ## add site information
  df <- merge(df, locations, by = "site")
  df <- melt(df, measure.vars = c("pConcess", "pFlona"), 
             variable.name = "ppf", value.name = "pArea", 
             value.factor = TRUE)
  levels(df$ppf) <- c("current", "potential")
  df <- subset(df, pArea > 0)
  df[, `:=`(med = med*area*pArea, 
            lwr = lwr*area*pArea, 
            upr = upr*area*pArea)]
  df <- df[, .(lwr = sum(lwr), med = sum(med), upr = sum(upr)),
           .(ppf, ncycle)]
  ini <- df[ncycle==1, -"ncycle"]
  ini$variable <- "prodi"
  res <- rbind(ini, df[, .(lwr = max(ncycle[lwr>=0.95*lwr[ncycle==1]]), 
                           med = max(ncycle[med>=0.95*med[ncycle==1]]), 
                           upr = max(ncycle[upr>=0.95*upr[ncycle==1]]), 
                           variable="tsust"), .(ppf)])
  return(res)
})
dftsust <- rbindlist(dftsust, idcol = "simid")
dftsust$simid <- as.numeric(dftsust$simid)
dftsust <- merge(dftsust, simulations, by = "simid")
dftsust[variable == "prodi", `:=`(lwr = lwr/logCycle, 
                                  med = med/logCycle, 
                                  upr = upr/logCycle)]
dftsust[variable == "tsust", `:=`(lwr = lwr*logCycle, 
                                  med = med*logCycle, 
                                  upr = upr*logCycle)]
dftsust[variable == "tsust" & med > 1000, med := 1000]
dftsust[variable == "tsust" & upr > 1000, upr := 1000]
dftsust = dcast(dftsust, omega0 + logIntensity + logCycle + ppf ~ variable, 
                value.var = c("lwr", "med", "upr"))
```

```{r tsust-vs-prodi, fig.width = 10, fig.height = 8, fig.cap = "Tradeoff between timber production and sustainability. The x-axis is the annual timber production under each scenario, and in all areas considered in the scenario (left panels: current concessions; right panels: potential concessions). The y-axis is the duration of constant production in each scenario, in years. The points are the median value over all simulations for each scenario; the vertical and horizontal error bars are the 95% credibility intervals. Colors represent logging rules (3 logging intensities x 3 logging cycle lengths) and the 3 values of initial proportion of commercial volume ($\\omega_0$) are represented by different panels, in increasing order from top to bottom. The target production of timber is 11 Mm$^3$.yr$^{-1}$, corresponding to the current timber production in Brazilian Amazonian forests. Only a few scenarios in the right panels (all potential concessions) are above this target, and all of them have a median duration of constant production lower than 200 years."}
## legend
palette <- function (name, indices = c(7,5,3)) {
  RColorBrewer::brewer.pal(9, name)[indices]
}
colours <- c(as.vector(sapply(c("Greens","Blues", "Reds"), palette)))
colour_palette <- c("LS"= colours[1], "LM"=colours[2], "LL"=colours[3],
                    "MS"=colours[4], "MM"=colours[5], "ML"=colours[6],
                    "HS"=colours[7], "HM"=colours[8], "HL"=colours[9])
df_rules <- data.table(logRules = c("LS","LM","LL","MS","MM","ML","HS","HM","HL"),
                       logIntensity = rep(10*1:3, each=3),
                       logCycle = rep(c(20,35,60), 3))
rules_legend <- ggplot(df_rules, aes(x=logIntensity, y=as.factor(logCycle),
                                     fill=logRules, label=logRules)) + 
  geom_raster() + scale_fill_manual(values = colour_palette) + 
  # geom_text(size=5) + 
  labs(x =expression("Logging intensity ("*m^3*ha^{-1}*")"), y = "Logging cycle (yrs)") + 
  theme(legend.position="none", aspect.ratio=1, 
        panel.background = element_blank(), 
        plot.margin = margin(2, 2, 2, 2, "cm"),
        text = element_text(size=10), 
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 15, r = 0, b = 0, l = 0))) 

## plot
dftsust <- merge(dftsust, df_rules, by = c("logIntensity", "logCycle"))
dftsust$ppf = factor(dftsust$ppf)
levels(dftsust$ppf) = c("Current concessions", "Potential concessions")

omega.labs <- c(`0.2`= 'omega[0] == 20*"%"', 
                `0.5`= 'omega[0] == 50*"%"', 
                `0.9`= 'omega[0] == 90*"%"')

## objective production line only on 2nd facet
add_objProd <- data.frame(ppf="Potential concessions", pos = c(125, 700, 700),
                          omega0 = unique(dftsust$omega0),
                          obj = 11, text = "Target production")

graph <- ggplot(dftsust, aes(y=med_tsust, x = med_prodi/1e6)) +
  geom_vline(data = add_objProd, aes(xintercept = obj), lty=2) +
  geom_text(data = add_objProd, aes(x = obj+1, y = pos, label = text), angle = 90) +
  geom_pointrange(aes(ymin=lwr_tsust, ymax=upr_tsust, color = logRules)) +
  geom_errorbarh(height = 0, aes(xmin = lwr_prodi/1e6, xmax = upr_prodi/1e6, color = logRules)) +
  facet_grid(omega0 ~ ppf, scales = "free", 
             labeller = labeller(omega0 = as_labeller(omega.labs, label_parsed))) +
  labs(x = bquote("Annual timber production (M"* m^3*.*yr^-1*")"), 
       y = "Duration of constant production (yrs)", 
       color = "Logging rules") + 
  scale_color_manual(values = colour_palette) +
  theme_bw() +
  theme(legend.position = "none") 

ggpubr::ggarrange(graph, rules_legend, widths = c(9,4))
```


```{r sust-production, results = "asis"}
dftsust[, lab_tsust := paste0(gsub("1000", ">1000", med_tsust), 
                              " yr (", lwr_tsust, " - ", 
                              gsub("1000", ">1000", upr_tsust), ")")]
dftab <- copy(dftsust)
dftab[, omega0 := paste0(omega0*100, "%")]
dftab[, ppf := gsub(" concessions", "", ppf)]
# dftab[, logIntensity := paste(logIntensity, "m$^3$.ha$^{-1}$")]
dftab[, logCycle := paste(logCycle, "yr")]
dftab <- dcast(dftab, omega0 + logIntensity + logCycle ~ ppf, value.var = "lab_tsust")

rows_bold <- which(as.numeric(gsub(">", "", tstrsplit(dftab$Potential, " ")[[1]]))>=500)
row_current <- which(dftab$omega0=="20%" &
                       dftab$logIntensity==20 &
                       dftab$logCycle == "35 yr")
  
flextable(dftab, col_keys = c("omega0", "logIntensity", "logCycle", "Potential")) %>%
  autofit() %>%
  compose(j="logIntensity",
  value = as_paragraph(
    as_chunk(as.character(logIntensity)),
    " m", as_sup("3"), ".ha", as_sup("-1")
  ),
  part = "body"
  ) %>%
  theme_vanilla() %>%
  set_header_labels(values = list(omega0 = "Comm. volume",
                                  logIntensity = "Logging intensity",
                                  logCycle = "Logging cycle",
                                  Potential = "Duration of maintained production")) %>%
  flextable::set_caption("Sustainability of all 27 scenarios, characterized by the duration of constant timber production (yrs, last 2 columns). The first 3 columns correspond to the input variables: the proportion of commercial volume (%); logging intensity (m$^3$.ha$^{-1}$); logging cycle length (yr). The last column is the duration of constant timber production in potential concession areas, as the median value of all iterations, followed by the 95% credibility interval (between parentheses).") %>%
  flextable::bold(i = rows_bold) %>%
  bg(i = row_current, bg = "lightgrey") %>%
  merge_v(1:3) %>%
  line_spacing(space = 0.7, part = "all")
```

```{r timber-stocks, fig.height=5, fig.width = 7, fig.cap="Commercial volume stocks in all potential concession areas for the 4 scenarios with a duration of maintained production > 500 years. The x-axis is the time after the first logging event (in years); the y-axis is the commercial volume stocks in all potential concession areas, in Mm$^3$. The colors represent the 4 scenarios, with the thick lines corresponding to the median and the shaded areas to the 95% credibility interval over all iterations. The scenario extracting 10 m$^3$ha$^{-1}$ every 60 years with a proportion of commercial timber of 90 % (top and bottom right figure, green line) is the most sustainable scenario with a median duration > 1000 years and an almost constant commercial timber stock."}
dftsust$simid <- as.numeric(as.factor(paste(dftsust$omega0, dftsust$logCycle, dftsust$logIntensity, dftsust$ppf)))
dfvolume$simid <- as.numeric(as.factor(paste(dfvolume$omega0, dfvolume$logCycle, dfvolume$logIntensity, dfvolume$ppf)))
sust_simid <- dftsust$simid[dftsust$med_tsust>=500]
dfvol_fig <- subset(dfvolume, simid %in% sust_simid)

dfvol_fig$Scenario <- factor(paste("Cycle:", dfvol_fig$logCycle, "yrs; Intensity:", 
                                   dfvol_fig$logIntensity, "m3/ha; omega0:", 
                                   as.numeric(dfvol_fig$omega0)*100,"%"))
levels(dfvol_fig$Scenario) <- c("35 yrs - 10 m$^3$.ha$^{-1}$ - $\\omega_0$ = 90%",
                                "60 yrs - 10 m$^3$.ha$^{-1}$ - $\\omega_0$ = 50%",
                                "60 yrs - 10 m$^3$.ha$^{-1}$ - $\\omega_0$ = 90%",
                                "60 yrs - 20 m$^3$.ha$^{-1}$ - $\\omega_0$ = 90%")

ggplot(subset(dfvol_fig, ppf=="potential"), aes(x=t, y = med/1e6)) +
  geom_line(aes(colour = Scenario), lwd=1.5) +
  geom_ribbon(alpha = 0.2, colour = NA,
              aes(fill = Scenario,
                  ymin = lwr/1e6,
                  ymax = upr/1e6)) +
  # facet_wrap(~ ppf, scales = "free", nrow = 2)  +
  labs(x = "Time after first logging event (yrs)", 
       y = bquote("Commercial volume (M"*m^3*")")) +
  theme_classic() +
  theme(legend.position = c(0.75, 0.88)) +
  scale_x_continuous(expand = c(0, 0)) + 
  scale_y_continuous(expand = c(0, 0)) +
  scale_color_brewer(palette = "Dark2", labels=lapply(levels(dfvol_fig$Scenario), TeX)) +
  guides(color = guide_legend(nrow=4), fill = FALSE)
```

None of the scenarios with an initial commercial volume proportion of 20% are sustainable after the first logging cycle (Figure\@ref(fig:tsust-vs-prodi); Table \@ref(tab:sust-production)). The present logging practices in the Brazilian Amazon usually correspond to a proportion of commercial species around 20%, a mean logging intensity of 15-20 m$^3$.ha$^{-1}$ and a rotation cycle of 35 years. Under such rules, the timber production can be maintained only for a single cutting cycle (35 years, grey line in Table \@ref(tab:sust-production)). Scenarios with higher proportion of commercial timber show longer duration of maintained production: `r dftsust[logIntensity==20 & logCycle==35 & omega0==0.5 & ppf == "Potential concessions", "lab_tsust"]` and `r dftsust[logIntensity==20 & logCycle==35 & omega0==0.9 & ppf == "Potential concessions", "lab_tsust"]` when the proportion of commercial species is respectively 50% and 90%. 

Only 4 out of all 27 scenarios (bold rows in Table \@ref(tab:sust-production)) have median durations of maintained production over 500 years, and only one is close to a sustained timber production *sensu stricto* (10 m$^3$.ha$^{-1}$ every 60 years with a 90% initial proportion of commercial timber species, Figure\@ref(fig:timber-stocks)). Three of these scenarios have an initial proportion of commercial volume of 90%, and three correspond to low intensity logging (10 m$^3$.ha$^{-1}$) with a cutting cycle of 60 years (Table \@ref(tab:sust-production)). 

The current timber production from the Brazilian Amazon is around 11 Mm$^3$ per year [@Vidal2020;@SFB2019]. Current concessions cannot come close to satisfying this demand for even one cycle under any scenario (Figure\@ref(fig:tsust-vs-prodi)). The maximum annual production from the current concession areas is `r signif(dftsust[logIntensity==30 & logCycle==20 & omega0==0.9 & ppf == "Current concessions", "med_prodi"], 3)/1e6`  Mm$^3$.yr$^{-1}$, which can only be reached under the most intensive scenarios: 30 m$^3$.ha$^{-1}$ of timber extracted every 20 years, with an initial proportion of commercial timber $\geq$ 50% (Figure\@ref(fig:tsust-vs-prodi)). Under such conditions, the maximum duration of maintained production is `r dftsust[logIntensity==30 & logCycle==20 & omega0==0.9 & ppf == "Current concessions", "lab_tsust"]` (Figure\@ref(fig:tsust-vs-prodi)). Under the present harvesting practices of 20 m$^3$.ha$^{-1}$ every 35 years with only 20% of the volume of trees $\geq$ 50 cm DBH of commercial species, the annual production from the first harvest is only 473,000 m$^3$ and the production will not be maintained after the first cutting cycle (35 years). Finally, with the current concession area, the longest maintained timber production (780 years) reaches 317,000 m$^3$ under an extraction rate of 20 m$^3$.ha$^{-1}$ every 60 years with a 90% proportion of commercial species (Figure\@ref(fig:tsust-vs-prodi)).

When considering all potential concession areas (35 Mha), the annual production of 11 Mm$^3$.yr$^{-1}$ could be maintained, at best, for 175 yr (35-350) if 90% of the initial volume is commercial, logging intensity is 20 m$^3$.ha$^{-1}$ and cutting cycles are 35 years (Figure\@ref(fig:tsust-vs-prodi); Table \@ref(tab:sust-production)). The two others scenarios that yield close to 11 Mm$^3$ during the first 250 years (Figure\@ref(fig:tsust-vs-prodi)) use logging intensities of 10 and 30 m$^3$.ha$^{-1}$ and logging cycles of 20 and 60 years, respectively. Under current rules (20 m$^3$.ha$^{-1}$ every 35 years and 20% proportion of commercial timber), the total annual production is 10 Mm$^3$.yr$^{-1}$ but cannot be maintained after the first logging cycle (Figure\@ref(fig:tsust-vs-prodi)).

# Discussion

The VDDE model is well suited to study timber recovery in forest concessions throughout the Brazilian Amazon. The data used to calibrate the model comes from an extensive network of plots covering the Amazon basin, most of which have been logged with some form of reduced impact logging techniques (skid trail planning, directional felling, vine cutting, etc.) [@Sist2015], similar to what is done in Brazilian logging concessions [REF]. It is important to note, however, that we have not included in our scenarios the potential effect of climate change-related disturbances such as fires and droughts, despite the likelihood of their future increase in the region [@Davidson2012]. Our results are therefore likely to be relatively optimistic, and correspond to the potential productivity of wood under the most favourable conditions. 

According to the results of our simulations, several challenges need to be addressed to achieve sustainable timber production in concession systems in the Brazilian Amazon. The first and simplest solution could be to lengthen minimum logging cycles and reduce maximum logging intensities, in order to get closer to our scenario with 10 m$^3$.ha$^{-1}$ of timber harvested every 60 years.

Changing the harvest limits would begin to address the sustained yields question, but would also decrease the annual timber production for the same area. Moreover, even the most intensive scenarios, the area of current concessions is obviously insufficient to reach an annual production of 11 Mm$^3$.yr$^{-1}$. Increasing the area of concessions is thus a priority if concessions are to meet the timber demand for the Amazon. **increasing the area of concessions: current trends, challenges?**
However, even when the 35 Mha of the potential concession area of 35 Mha show strong limitation to ensure an annual sustainable production of 11 Mm$^3$ on a long term basis as our simulations suggest that this production can be sustained for at best 170 years with a 90% proportion of commercial species.

The last, and probably the most important challenge is to increase the list of commercial species to harvest at least 50% of the volume from trees $\geq$ 50 cm DBH, and ideally 90%. The study from @Piponiot2019 showed that by considering all species that have been registered as commercial at least once, 80-95% of the volume trees $\geq$ 50 cm DBH in a network of plots covering the Brazilian Amazon could have commercial value [@radam]. This result is encouraging, but it could mean that in the list of commercial species, some may have lower mechanical properties and market prices than the high-value species that were harvested in the first logging cycle. The harvesting and valuation of these new species must involve drastic changes in the entire wood supply chain. One of the first barriers is at the sawmill level: processing a large variety of species with different mechanical properties can pose some technical challenges for sawmills [REF]. In addition, only about 40% of the volume entering the sawmill is processed into lumber, and most of the remaining material is burned or left unused [@Pereira2010;@DeLima2020]. Improving the efficiency and diversification of sawmills could therefore help to meet the demand for wood in the Amazon. Changing consumer habits is also a powerful lever to increase the commercial value of some lesser-known wood species, and has been the goal of some advertising campaigns by environmental NGOs [@FSC2016]. 

However, consumers are unlikely to be willing to pay high prices for these lesser-known wood species. This, combined with lower harvest intensities, could hinder the profitability of selective harvesting. In addition, logging concession operators compete with illegal loggers who do not comply with official logging regulations and do not pay taxes, and can therefore sell their timber at low prices. The economic and ecological sustainability of logging is therefore closely linked to forest law enforcement and the fight against illegal logging. 

One of the main obstacles to timber recovery is that, in most cases, harvested species take a long time to recover because, in the absence of human intervention, individuals of other tree species, and in some cases lianas, can take advantage of the increased availability of light in logging gaps and replace the harvested species [REF]. For this reason, many silvicultural treatments have been developed to liberate future crop trees, for example by poisoning overtopping trees with no commercial value [REF]. These treatments have been shown to increase the recovery of commercial timber volume after felling, and can be carried out at reasonable prices [@Roopsind2018;@Mills2019]. However, these treatments are rarely applied in the tropics, **for reasons: cost? lack of expertise? insecurity of land tenure? etc ** [REF]. A better understanding of the potential effects of silvicultural treatments on a regional scale could therefore serve as a motivation for increased investment in these techniques. 

- **initiating a forest transition -> new ways of producing timber: plantations, active restoration, silviculture**




# Acknowledgements {-}


# References {-}
