---
title: "Sustainability of Brazilian forest concessions"
output: 
  pdf_document:
    keep_md: true
    number_sections: true
bibliography: myBiblio.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, 
                      root.dir = rprojroot::find_rstudio_root_file())
# load libraries
packages_needed <- c("knitr", "kableExtra", "data.table", "ggplot2", "parallel", "sp", "truncnorm")
packages_to_install <- packages_needed[!( packages_needed %in% rownames(installed.packages()))]
if (length(packages_to_install) > 0)
  install.packages(packages_to_install)
lapply(packages_needed, require, character.only = TRUE)

if (!dir.exists("cache"))
  dir.create("cache")
```

# Introduction

Since the 1970s, selective logging has established itself as the main silvicultural system in tropical regions. This system is based on very simple rules: the exploitation of a few commercial trees having reached a minimum cutting diameter and letting the forest recover during a rotation period generally between 25 and 35 years. 

During the last three decades many studies aiming to assess the long term impact of selective logging in the Amazon have shown that in general the cycle length and harvesting intensities were insufficient to recover the commercial stock within the 30-35 year cycle [@Piponiot2019a].

There is evidence that the current harvests of 10 to 30 m$^3$3 of logs per hectare with a cutting cycle of 30 years can only be sustained, over multiple cycles, if high-value, slow-growing hardwoods are replaced. By species of fast growth and low density, little valued in the current market [@Alder2000;@Keller2004;@Phillips2004a;@VanGardingen2006;@Schulze2008b].

Although Reduced impact logging techniques were seen as a promising alternative to reduce the damage of logging and consequently to improve timber volume recovery [@Schulze2008b], most of the studies assessing the long-term impacts of such techniques in the tropics including the Amazon, showed that timber volume will recover at best by 50% within the rotation cycle duration fixed by legislation [@DeAvila2017].

Despite the low recovery of timber stocks in logged forests, selective logging is still a widespread and economically viable land use in the Amazon because around 75% of the five hundred million ha of forests are still intact [@Potapov2017] and have accumulated highly valuable timber over centuries. It is very likely, however, that most logged forests will have a dramatic reduction in timber yields after the first logging rotation [@Piponiot2019a;@Putz2012].

In 2006 Brazil created the SFB which aims to implement a very ambitious system of long-term logging concessions with the ultimate goal of eradicating illegal logging and concentrating Amazonian timber production within those concessions [@Brazil2006]. Today, these concessions are still limited in size (1.5 Mha total area) and their timber production (221 thousand m$^3$ annual production) represents only 2% of the timber extracted in the Brazilian Amazon [@SFB2019].

The first objective of this paper is to assess a sustainable logging regime (logging intensity and rotation length) able to ensure a long-term and constant timber production in the Brazilian Amazon. The second objective is to assess if the potential annual timber production based on the potential concession areas in the Brazilian Amazon is in adequacy with the present and future (?) timber demand. The present timber production is 11 Mm$^3$.yr$^{-1}$ [@Vidal2020;@SFB2019]. 

In this study we used an Amazon-wide timber recovery model developed by @Piponiot2019a to estimate the total timber volume that could be produced in Brazilian logging concessions under varying cycle lengths, logging intensities and pool of commercial species. We identified the conditions under which selective logging was sustainable from a timber production point of view and what its production capacity was in relation to the demand for wood. 


# Methods

## Study areas - Brazilian concessions

Our study focuses on the Brazilian forest concessions. These concessions are located in public forests and currently cover an area of 1.5 Mha in the Brazilian Amazon [@SFB2019]. We retrieved the map of forests currently under concession from [@SFB2020]. 

The map of all public forests was downloaded from the Brazilian Forest Service website [@SFB2019a]. The maximum potential area of concessions was defined as all public forests in the Brazilian Amazon biome that are designated for sustainable use, excluding community forests, indigenous territories and military areas [as defined in @SFB2019, p. 112].  

```{r map-brazil-concess}
if (!file.exists("data/pconcessions.Rdata")) {
  ## concessions
  concessions <- rgdal::readOGR(dsn = "data_sfb/final", layer = "BRflopub")
  ext2 <- floor(raster::extent(concessions)) + c(0, 1, 0, 1)
  rst <- raster::raster(resolution = 0.01, ext = ext2)
  raster_concessions <- raster::rasterize(concessions, rst)
  raster_concessions2 <- !is.na(raster_concessions)
  pconcessions <- raster::aggregate(raster_concessions2, fact = 100)
  pconcessions <- raster::as.data.frame(pconcessions, xy = TRUE)
  colnames(pconcessions) <- c("long", "lat", "pConcess")
  ## flonas
  flonas <- rgdal::readOGR(dsn = "data_sfb/final", layer = "BRflopub")
  ext2 <- floor(raster::extent(flonas)) + c(0, 1, 0, 1)
  rst <- raster::raster(resolution = 0.01, ext = ext2)
  raster_flonas <- raster::rasterize(flonas, rst)
  raster_flonas2 <- !is.na(raster_flonas)
  pflonas <- raster::aggregate(raster_flonas2, fact = 100)
  pflonas <- raster::as.data.frame(pflonas, xy = TRUE)
  colnames(pflonas) <- c("long", "lat", "pFlona")
  
  pconcessions <- merge(pconcessions, pflonas, by = c("long", "lat"), all = TRUE)
  pconcessions[is.na(pconcessions$pConcess), "pConcess"] <- 0
  pconcessions <- subset(pconcessions, pConcess > 0 | pFlona > 0)
  save(pconcessions, file = "data/pconcessions.Rdata")
} else load("data/pconcessions.Rdata")

load("data/areaLogging.Rdata")
areaLoggingBR <- areaLogging[, c("long", "lat", "areaTot")]
areaLoggingBR <- merge(areaLoggingBR, pconcessions, by = c("long", "lat"), all = TRUE)
areaLoggingBR$pConcess[is.na(areaLoggingBR$pConcess)] <- 0
areaLoggingBR$pFlona[is.na(areaLoggingBR$pFlona)] <- 0
## all pixels with flonas (potential concessions): will be used in simulations
locations <- subset(areaLoggingBR, pFlona > 0)
locations$site <- 1:nrow(locations)
```

## The VDDE model 

In this study we used the volume dynamics with differential equations (VDDE) model [@Piponiot2018]. 
The VDDE model focuses on the volume of all live trees with diameter at breast height (DBH) $\geq$ 50 cm (the standard minimum cutting size in the Amazon Basin): this quantity will be referred to as total volume. By contrast, only a portion of this volume is composed of commercial species and will be referred to as commercial volume. 

<!-- The initial (i.e. pre-logging) proportion of commercial volume is a parameter of the model.  -->

<!-- In this model, the total volume is modelled as a function of a new variable, the forest maturity, that is itself estimated using volume dynamics data (volume changes from growth and mortality).  -->

The VDDE model was calibrated at the Amazon Basin scale in a Bayesian framework with data from 3500 ha of forest plots, among which 845 ha are from 15 sites monitored for as long as 30 years after being subjected to selective logging [@Sist2015;@Piponiot2019a]. 



```{r illus-vol-recov, fig.height = 5, fig.width=7}

source("R/volume.R")

tobs = seq(150,180,2)
vobs = rnorm(length(tobs), volume(tobs, ag = 5, am = 1, bg = 0.008, bm = 0.004, th = 0.035), 1)

curve(volume(x, ag = 5, am = 1, bg = 0.008, bm = 0.004, th = 0.035), 
      xlim = c(0,300), ylab = expression("Volume ("*m^3*ha^{-1}*")"), xlab = "Estimated maturity", lty = 2)
points(tobs, vobs, pch = 16)
legend("topleft", legend = c("Observations", "Predictions"), bty = "n", 
       lty = c(0, 2), lwd = c(0, 1), pch = c(16, NA))

```

The maturity increases (1 unit per year) when there is no disturbance and decreases abruptly when there is a disturbance, for example selective logging. 

```{r illus-disturb, fig.height = 5, fig.width=7}

library(diagram)

curve(volume(x, ag = 5, am = 1, bg = 0.008, bm = 0.004, th = 0.035), 
      xlim = c(0,300), ylab = expression("Volume ("*m^3*ha^{-1}*")"), xlab = "Estimated maturity")
curvedarrow(c(180, volume(180, ag = 5, am = 1, bg = 0.008, bm = 0.004, th = 0.035)), 
            c(100, volume(100, ag = 5, am = 1, bg = 0.008, bm = 0.004, th = 0.035)), 
            lwd = 2, lty = 1, lcol = "red", 
            arr.pos = 0.95, curve = 0.3, dr = 0.01, segment = c(0, 1))
text(x=140, y = 100, labels = "Disturbance", pos = 2, col=2)
curvedarrow(c(105, volume(100, ag = 5, am = 1, bg = 0.008, bm = 0.004, th = 0.035) - 4), 
            c(150, volume(150, ag = 5, am = 1, bg = 0.008, bm = 0.004, th = 0.035) - 5),
            lty = 2, curve = -0.01, arr.pos = 0.95)
text(x=145, y = 50, labels = "Recovery", pos = 3)

```

### Proportion of commercial volume

Only part of the total volume is commercial: the pre-logging proportion of commercial volume is $\omega_0$. Because logging targets commercial species, their proportion in the total volume $\omega$ decreases after logging (see the methodology paper for a complete decription of the model [@Piponiot2018]), but can increase again through recruitment of small trees (< 50 cm DBH). 

### Introducing a new module: silvicultural treatments 

According to the literature, the effect of silvicultural treatments such as liana removal (and in some cases tree) xxx

```{r illustr-silviculture, fig.width = 8, fig.height=5}
## parameters
tmax = 100
ag = 5
bg = 0.01
am = 4
bm = 0.005
theta = 0.002
intpR = 5
slopepR = -1.5
om0 = 0.8

# test different silvilcultural effects
## increase in growth of commercial trees
lbd = 0.25 # steepness of the decrease
silv_effect = list(rep(1, tmax), ## no effect
                   1 + 0.2*(1 - 1 / (exp(lbd*(10-(1:tmax))+log(4)) + 1)), ## 20% - 10 years
                   1 + 0.2*(1 - 1 / (exp(lbd*(20-(1:tmax))+log(4)) + 1)), ## 20% - 20 years
                   1 + 0.8*(1 - 1 / (exp(lbd*(10-(1:tmax))+log(4)) + 1)), ## 80% - 10 years
                   1 + 0.8*(1 - 1 / (exp(lbd*(20-(1:tmax))+log(4)) + 1))) ## 80% - 20 years

names(silv_effect) <- c("none", "20% - 10 years", "20% - 20 years", "80% - 10 years", "80% - 20 years")

simulations <- lapply(silv_effect, function(K) {
  # initialization
  V = c(100) 
  om = c(0.2) 
  vtest = volume(t = 1:500, ag = ag, am = am, bg = bg, bm = bm, th = theta)
  t0_test = which.min(abs(vtest-100))
  for (t in 1:(tmax-1)) {
    pR = 1 / (1 + exp(-(intpR + slopepR * log(V[t]))))
    eta = pR * (om0*K[t] + 1 - om0) + (1 - pR) * (om[t]*K[t] + 1 - om[t]) 
    g = (ag*(1-exp(-bg*(t0_test+t))) - theta*V[t])*eta
    m = am*(1-exp(-bm*(t0_test+t)))
    V[t+1] = V[t] + g - m
    om[t+1] = min((V[t]*om[t] + (ag*(1-exp(-bg*(t0_test+t))) - theta*V[t]) * K[t] * (om0*pR + om[t]*(1-pR)) - m*om[t] ) / V[t+1], 1)
  }
  return(data.frame(t = 1:tmax, silv = (K-1)*100, vol = V, omega = om*100))
})

simulations <- rbindlist(simulations, idcol = "treatment")
simulations[, vcom := vol*omega/100]
dfsim <- melt(simulations, measure.vars = c("silv", "vol", "omega", "vcom"))
levels(dfsim$variable) <- c("Effect of silvicultural treatments\non commercial volume growth (%)", 
                            "Total volume (m3/ha)", "Proportion of commercial volume (%)", "Commercial volume (m3/ha)")

## graph
library(ggplot2)
ggplot(dfsim, aes(x = t, y = value, color = treatment)) + 
  geom_line() +
  facet_wrap(~ variable, scales = "free") +
  theme_bw() + 
  expand_limits(x = 0, y = 0) + 
  scale_x_continuous(expand = c(0, 0)) +
  labs(x = "Recovery time (yr)", y = "")
```

### Model calibration at the Amazonian scale 

This model was calibrated with data from TmFO plots to make spatially-explicit predictions of post-logging timber recovery in Amazonia (paper submitted to Environmental Research Letters). 

![Timber recovery predictions (% of pre-logging timber stocks) from the model calibrated with TmFO data, as a function of logging cycle length (columns) and logging intensity (rows).](graphs/recovery_amazonia.PNG)


## Simulations

We simulate all combinations of the following parameters: 

- initial proportion of commercial timber: 20%, 50% or 90%;

- logging intensity: 10, 20 or 30 m$^3$.ha$^{-1}$;

- length of cutting cycles: 20, 35 or 60 years;

- logged areas: current concessions or all Amazonian Flonas;

- effect of silvicultural treatments: no effect, 20% or 50% increase of commercial timber growth during 20 years. 

The total number of simulations is 3x3x3x3x2 = 162. 

Simulation over the first 200 years after the first logging event

```{r define-simulations}
timeLength <- 200
omega0 <- c(0.2, 0.5, 0.9)
logIntensity <- (1:3)*10
logCycle <- c(20, 35, 60)
logArea <- c("current", "potential")
silvTreat <- c(0, 0.2, 0.5)
simulations <- expand.grid(omega0 = omega0, 
                           logIntensity = logIntensity, 
                           logCycle = logCycle, 
                           silvTreat = silvTreat)
simulations$simid <- 1:nrow(simulations)
```

In the results, we only show simulations that have a constant production of timber during the 200 years of the simulation (with a 10% tolerance).

```{r run-simulations}
if (!dir.exists("cache/simulations_concessionsBR/"))
  dir.create("cache/simulations_concessionsBR/")  

all_i = 1:nrow(simulations)
del_i = as.numeric(gsub("recov|\\.Rdata", "", list.files("cache/simulations_concessionsBR/")))
missing_simus <- all_i[!all_i%in%del_i]

if (length(missing_simus) > 0) {
  source("R/simulateLogging.R")
  
  # Calculate the number of cores
  no_cores <- detectCores() - 2
  # Initiate cluster
  cl <- makeCluster(no_cores)
  clusterEvalQ(cl, library(data.table))
  clusterExport(cl, varlist = c("simulateLogging", "simulations", "timeLength", "locations", "rtruncnorm"))
  
  recovCycles <- parLapply(cl, missing_simus, function(j) {
    recov <- simulateLogging(
      timeLength = timeLength,
      logIntensity = simulations$logIntensity[j],
      logCycle = simulations$logCycle[j], 
      omega0 = simulations$omega0[j],
      longitude = locations$long, 
      latitude = locations$lat,
      silv = c(simulations$silvTreat[j], 20),
      uncertainties = TRUE, keepAll = FALSE
    )
    save(recov, file = paste0("cache/simulations_concessionsBR/recov", j, ".Rdata"))
    return(recov)
  })
  
  stopCluster(cl)
} 
```

```{r prepare-results}
outputs <- lapply(list.files("cache/simulations_concessionsBR/", full.name = TRUE), function(fnm){
  load(fnm)
  get("recov")
})
names(outputs) <- gsub("recov|\\.Rdata", "", list.files("cache/simulations_concessionsBR/"))

results <- rbindlist(outputs, idcol = "simid")
results$simid <- as.numeric(results$simid)

## multiply by total area ####
results <- merge(results, locations, by = "site")
results <- melt(results, measure.vars = c("pConcess", "pFlona"), 
                variable.name = "ppf", value.name = "pArea", value.factor = TRUE)
levels(results$ppf) <- c("current", "potential")
results <- subset(results, pArea > 0)
results[, c("lwr", "med", "upr")] <- results[, c("lwr", "med", "upr")]*results$pArea*results$areaTot
results <- results[, .(lwr = sum(lwr), med = sum(med), upr = sum(upr)), 
                   .(simid, ncycle, trec, variable, ppf)]

## get timber production
dfvext <- subset(results, variable == "vextReal")
# add simulation info
dfvext <- merge(dfvext, simulations, by = "simid")

## get timber stocks
dfvolume <- subset(results, variable != "vextReal")
dfvolume <- dcast(dfvolume, ncycle + trec + simid + ppf ~ variable, value.var = c("lwr", "med","upr"))
dfvolume$lwr <- dfvolume$lwr_omega*dfvolume$lwr_volume
dfvolume$med <- dfvolume$med_omega*dfvolume$med_volume
dfvolume$upr <- dfvolume$upr_omega*dfvolume$upr_volume
dfvolume <- merge(dfvolume, simulations, by = "simid")

# add all recovery years ###
dfvolume <- dfvolume[, .(
  lwr = seq(min(lwr), max(lwr), length.out=logCycle[1]), 
  med = seq(min(med), max(med), length.out=logCycle[1]), 
  upr = seq(min(upr), max(upr), length.out=logCycle[1]), 
  trec = seq(1, logCycle[1])), 
  .(ncycle, simid, ppf, omega0, logIntensity, logCycle, silvTreat)]
dfvolume[, t := (ncycle-1)*logCycle + trec]
```

```{r annualise-harvests}
annualise <- function(X, period, X0) {
  mat = matrix(X0 / period, ncol = length(X), nrow = period)
  for (i in 1:period) {
    mat[i, i:length(X)] = X[1:(length(X)-i+1)]/period
  }
  return(colSums(mat))
}

dfvolume_ann = dfvolume[order(t) , .(lwr = annualise(lwr, logCycle, first(lwr)),
                                     med = annualise(med, logCycle, first(lwr)),
                                     upr = annualise(upr, logCycle, first(lwr)), t),
                        .(simid, ncycle, omega0, logIntensity, logCycle, silvTreat, ppf)]

dfvext_ann <- dfvext[, .(lwr = rep(lwr/logCycle, each = logCycle[1]),
                         med = rep(med/logCycle, each = logCycle[1]),
                         upr = rep(upr/logCycle, each = logCycle[1]),
                         t = (ncycle-1)*logCycle[1] + 1:logCycle[1]),
                     .(simid, ncycle, omega0, logIntensity, logCycle, silvTreat, ppf)]
dfvext_ann <- subset(dfvext_ann, t <= timeLength)
```

## Definition of sustainability

Sustainability was defined in two ways (we use the median value of all runs): 

(i) the total volume production must stay constant throughout the 200 years of simulation, with a 5% tolerance; 

(ii) the total volume stocks must be at least 50% of their initial value at the end of the 200 years of simulation. 
 

# Results

```{r sustainable-combinations}
fin_prod <- lapply(outputs, function(df) { 
  df <- subset(df, variable == "vextReal")
  df <- merge(df, locations, by = "site")
  df[, `:=`(medF = med*areaTot*pFlona, 
            lwrF = lwr*areaTot*pFlona, 
            uprF = upr*areaTot*pFlona, 
            medC = med*areaTot*pConcess, 
            lwrC = lwr*areaTot*pConcess, 
            uprC = upr*areaTot*pConcess)]
  ini <- colSums(df[ncycle==1, c("lwrF", "medF", "uprF", "lwrC", "medC", "uprC")])
  fin <- colSums(df[ncycle==max(ncycle), c("lwrF", "medF", "uprF", "lwrC", "medC", "uprC")])
  res <- data.table(rbind(ini, fin, fin/ini))
  res$variable <- c("ini", "fin", "prop")
  return(res)
})
fin_prod <- rbindlist(fin_prod, idcol = "simid")
fin_prod$simid <- as.numeric(fin_prod$simid)
fin_prod <- merge(fin_prod, simulations, by = "simid")

sust_simus <- subset(fin_prod, variable == "prop" & medF >=0.95)
## only 20 simulations are 'sustainable' ie they can produce the same amount of timber for at least 200 years
table(sust_simus$logCycle, sust_simus$logIntensity)
table(sust_simus$omega0)
table(sust_simus$silvTreat)

sust_prodF <- subset(fin_prod, simid %in% sust_simus$simid & variable == "ini") 
```

After 200 years, `r nrow(sust_simus)` (out of `r nrow(simulations)`) kept a constant total volume production. The maximum volume produced is `r signif(max(sust_prodF$medC)/1e3, 3)` km$^3$ in current forest concessions and `r signif(max(sust_prodF$medF)/1e6, 3)` Mm$^3$ in all potential concessions (i.e. all available public forests). 


```{r timber-stocks-br, fig.height=6, fig.width = 10}
dfvol_fig <- subset(dfvolume_ann, ppf == "potential" & simid %in% sust_simus$simid)

dfvol_fig$omega0 = factor(dfvol_fig$omega0)
levels(dfvol_fig$omega0) = paste0("omega0 = ", as.numeric(levels(dfvol_fig$omega0))*100,"%")

dfvol_fig$silvTreat = factor(dfvol_fig$silvTreat)
levels(dfvol_fig$silvTreat) = paste0("Silv. effect = ", as.numeric(levels(dfvol_fig$silvTreat))*100,"%")

dfvol_fig$logrules <- paste("Cycle:", dfvol_fig$logCycle, "yrs; Intensity:", dfvol_fig$logIntensity, "m3/ha")

ggplot(dfvol_fig, aes(x=t, y = med/1e6)) + 
  geom_line(aes(colour = logrules)) +
  geom_ribbon(alpha = 0.2, colour = NA, 
              aes(fill = logrules, 
                  ymin = lwr/1e6, 
                  ymax = upr/1e6)) + 
  facet_grid(silvTreat ~ omega0, scales = "free")  + 
  labs(x = "Time (yrs)", y = "Commercial volume (Mm3/yr)") +
  theme_bw() + 
  theme(legend.position = "top") 
```

# References