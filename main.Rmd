---
title: "Sustainable logging - main document"
output: 
  html_document:
    theme: journal
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, 
                      root.dir = rprojroot::find_rstudio_root_file())
calc_data = FALSE

# load libraries
library(knitr)
library(kableExtra)
library(data.table)
library(ggplot2)
```

# Exploring timber volume trajectories

We will first test 5 scenarios and look at the predicted trajectories. The location stays the same (here we use Manaus coordinates in central Amazonia).

Four input variables differ among scenarios: 

- the logging intensity (in m$^3$ha$^{-1}$)

- the length of the logging cycle (in years)

- $\omega 0$: the pre-logging proportion of commercial timber 

- $dti$: the pre-logging disturbance factor (between 0 and 1): when $dti=0$, the site has suffered no human disturbance previous to logging; if $dti=1$, the site has been completely disturbed and clearcut. 

```{r}
timeLength = 1000
logIntensity = rep(10, 5); logIntensity[2] = 30
logCycle = rep(35, 5); logCycle[3] = 65
omega0 = rep(0.70, 5); omega0[4] = 0.90
longitude = rep(-60.6, 5) ## location: Manaus
latitude = rep(-3.3, 5)
dti = rep(0.10, 5); dti[5] = 0.40
tabScenario = data.table(scenario = c("default", "highIntensity", "longCycle", "divCommSpecies", "prevDisturb"), 
                         logIntensity, logCycle, omega0, dti)
```

## Without uncertainties

The following table summarizes the 5 scenarios and the values of each input variable. 

```{r}
tabScenario %>%
  kable() %>%
  kable_styling()
```

The following figure shows the predicted trajectory of timber volume stocks for each of the 5 scenarios. 

```{r illustr_traj, fig.height=4, fig.width=10}

source("functions/timbRecovery.R")

recov = timbRecovery(timeLength, logIntensity, logCycle, omega0, longitude, latitude, dti)

dfrecov = do.call(data.table, recov[[1]])
colnames(dfrecov) = tabScenario$scenario
dfrecov$t = 1:timeLength
dfrecov = melt(dfrecov, id.vars = "t", value.name = "volume", variable.name = "scenario")

ggplot(dfrecov, aes(x=t, y = volume, color = scenario)) + geom_line() + xlab("Time since first logging event (yr)") + ylab("Commercial timber volume (m3/ha)") 
```

The following figure shows the predicted trajectory of timber volume stocks for each of the 5 scenarios. 

```{r illustr_vextReal, fig.height=2, fig.width=10}
vextReal = data.table(t(recov[[2]]))
colnames(vextReal) = tabScenario$scenario
vextReal$ncycle = 1:nrow(vextReal)
vextReal = melt(vextReal, id.vars = "ncycle", value.name = "intensity", variable.name = "scenario")

ggplot(vextReal, aes(x= ncycle, y = intensity, colour = scenario)) + geom_line() + facet_wrap(~scenario, nrow = 1) + 
  xlab("Number of cutting cycles") + ylab("Volume extracted")
```

Only the "longCycle" scenario maintains high levels of timber volume and a constant production after 1000 years; it can be considered sustainable. 


## With uncertainties

The following figure shows the predicted trajectory of timber volume stocks for each of the 5 scenarios. 

```{r illustr_traj_uncert, fig.height=4, fig.width=10}

source("functions/timbRecoveryUncert.R")

ptm <- proc.time()
recov = timbRecoveryUncert(timeLength, logIntensity, logCycle, omega0, longitude, latitude, dti)
proc.time() - ptm

dfrecov = recov[[1]]
dfrecov$scenario = tabScenario$scenario[dfrecov$site]

ggplot(dfrecov, aes(x=t, y = med, color = scenario, ymin = inf, ymax = sup)) + 
  geom_ribbon(aes(fill = scenario), colour = NA, alpha = 0.1) + geom_line() + theme(legend.position = "none") +
  xlab("Time since first logging event (yr)") + ylab("Commercial timber volume (m3/ha)")  + facet_wrap(~scenario)

```

The following figure shows the predicted trajectory of timber volume stocks for each of the 5 scenarios. 

```{r illustr_vextReal_uncert, fig.height=2, fig.width=10}
vextReal = data.table(recov[[2]])
vextReal$scenario = tabScenario$scenario[vextReal$site]

ggplot(vextReal, aes(x = ncycle, y = med, color = scenario, ymin = inf, ymax = sup)) + 
  geom_ribbon(aes(fill = scenario), colour = NA, alpha = 0.1) + geom_line() + theme(legend.position = "none") +
  facet_wrap(~scenario, nrow = 1) + xlab("Number of cutting cycles") + ylab("Volume extracted")
```


## Configurations of logging that are sustainable

For now we consider logging sustainable if the production (max-likelihood) stays constant during the first 100 cycles. 

```{r}
timeLength = 1000

tabScenario = data.table(expand.grid(logIntensity = seq(5,35,5), 
                                     logCycle = seq(10,100,10), 
                                     omega0 = seq(0.1,1,0.1), 
                                     dti = seq(0,0.5,0.1)))
tabScenario$longitude = -60.6
tabScenario$latitude = -3.3

if (calc_data) {
  recov = timbRecovery(timeLength, tabScenario$logIntensity, 
                       tabScenario$logCycle, tabScenario$omega0, 
                       tabScenario$longitude, tabScenario$latitude, 
                       tabScenario$dti)
  
  vextReal = data.table(tabScenario, recov[[2]])
  dfvextReal = melt(vextReal, id.vars = colnames(tabScenario), variable.name = "ncycle", value.name = "vext")
  dfvextReal$ncycle = as.numeric(gsub("V", "", dfvextReal$ncycle))
  
  dfSustain = dfvextReal[,.(pVextTot = sum(vext)/(logIntensity*last(ncycle))), .(logIntensity, logCycle, omega0, dti)]
  save(dfSustain, file = "Rdata_files/dfvext_sustain.Rdata")
  
} else load("Rdata_files/dfvext_sustain.Rdata")

```

### In perfect conditions 

The following picture shows the proportion of extracted volume compared to the expected logging intensity over the first 100 cycles. If this proportion is 1, then logging can be considered sustainable. 

Here we hpothesize that $\omega_0 = 1$ (all species are commercial) and that $dti = 0$ (no pre-logging anthropogenic disturbance). 

```{r, fig.height = 3, fig.width=5}
dfSustain$sustainable = (dfSustain$pVextTot > 0.99)

ggplot(subset(dfSustain, omega0==1 & dti == 0) ) + 
  geom_raster(aes(x = logIntensity, y = logCycle, fill = pVextTot)) + 
  theme(aspect.ratio=1) 
ggplot(subset(dfSustain, omega0==1 & dti == 0) ) + 
  geom_raster(aes(x = logIntensity, y = logCycle, fill = sustainable)) + 
  theme(aspect.ratio=1) 
```

### Effect of diversifying commercial species (ie changing $\omega_0$)

```{r, fig.height = 4, fig.width=10}
dfSustain$lab_omega0 = factor(dfSustain$omega0)
levels(dfSustain$lab_omega0) = paste0("omega0 = ", as.numeric(levels(dfSustain$lab_omega0))*100, "%")

ggplot(subset(dfSustain,dti == 0) ) + 
  geom_raster(aes(x = logIntensity, y = logCycle, fill = sustainable)) + 
  theme(aspect.ratio=1) + facet_wrap( ~ lab_omega0, nrow = 2)
```

### Effect of adding prelogging anthropogenic disturbances (ie changing $dti$)

```{r, fig.height = 4, fig.width=10}
ggplot(subset(dfSustain, omega0 == 1) ) + 
  geom_raster(aes(x = logIntensity, y = logCycle, fill = sustainable)) + 
  theme(aspect.ratio=1) + facet_wrap( ~ paste0("dti = ", dti*100, "%"), nrow = 2)
```